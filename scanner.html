<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz QR Tự Chiếu</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<style>
  /*nền*/
  section.img {
    width: 100%;              /* chiếm toàn chiều ngang */
    max-width: 1300px;         /* giới hạn chiều rộng */
    position: relative;       /* để các phần tử con nằm trên ảnh nếu cần */
  }
  section.img img {
      width: 100%;              /* ảnh chiếm toàn bộ chiều rộng của section */
      height: auto;             /* chiều cao tự động để giữ tỉ lệ */
      display: block;           /* loại bỏ khoảng trắng dưới ảnh */
  }
  /* Câu hỏi overlay trên ảnh nền */
#question {
    position: absolute;                 /* nổi trên ảnh nền */
    top: 50px;                          /* khoảng cách từ trên section */
    left: 110px;                         /* cách trái */
    right: 480px;                        /* cách phải */
    background: rgba(255, 255, 255, 0.85); /* nền mờ để đọc được chữ */
    padding: 20px;                      /* khoảng cách bên trong */
    border-radius: 12px;                /* bo góc mềm mại */
    font-size: 35px;                     /* cỡ chữ */
    line-height: 1.5;                   /* khoảng cách dòng */
    color: #834103d5;                        /* chữ tối */
    box-shadow: 0 4px 12px rgba(0,0,0,0.3); /* bóng nổi */
    z-index: 10;     
    white-space: pre-line;                   /* luôn nổi trên ảnh nền */
}

/* Vùng camera + upload nằm trên ảnh và dưới câu hỏi */
#reader, 
#answerResult,
#nextBtn,
#uploadDiv {
    position: absolute;
    z-index: 20;             /* nổi trên ảnh và trên cả câu hỏi */
}

/* Camera */
#reader {
    top: -680px;     
    left: 845px;         /* chỉnh vị trí dưới câu hỏi */
    width: 300px;
}
/* Text hiện kết quả */
#answerResult {
    top: 290px;  
    left: 845px;            /* bên dưới camera */
    font-size: 22px;
    border-radius: 8px;
    width: 280px;
    text-align: center;
    color: rgb(163, 121, 4);
}
/* Upload QR */
#uploadDiv {
    top: 345px;  
    left: 845px;         
    font-size: 22px;
    width: 280px;
    text-align: center;
    color: rgb(163, 121, 4);
}
/* Nút chuyển câu */
#nextBtn {
    top: 400px;             
    left: 920px; /* dưới answer */
    padding: 10px 20px;
    font-size: 20px;
    border-radius: 10px;
    background: #fbfcbe; 
    border: 2px solid #d4d72c;
    cursor: pointer; 
    color: #7a790a;
}

/* Form nhập tên người chơi như thông báo overlay */
#playerForm {
    position: fixed;          /* nổi trên tất cả */
    top: 50%;                 /* căn giữa theo chiều dọc */
    left: 50%;                /* căn giữa theo chiều ngang */
    transform: translate(-50%, -50%); /* thực sự căn giữa */
    background: rgba(255, 255, 255, 0.95); /* nền trắng mờ */
    color: #02a2ffd5;
    font-size: 30px;
    padding: 25px 30px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(11, 135, 236, 0.4);
    text-align: center;
    z-index: 100;             /* luôn nổi trên quiz */
}

/* Input tên người chơi */
#playerNameInput {
    font-size: 18px;
    padding: 8px 12px;
    width: 200px;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-right: 10px;
}

/* Nút Bắt đầu Quiz */
#startBtn {
    font-size: 18px;
    padding: 8px 16px;
    border-radius: 8px;
    border: 2px solid #03acfd;
    background: #54cdf138;
    cursor: pointer;
    color: #1a9900;
    transition: all 0.2s ease;
    margin-top: 10px;
}
#startBtn:hover {
    background: #f8f9a0;
    border-color: #caca1f;
}

/* Thống kê tiến trình quiz */
#stats {
    position: absolute;           /* nổi trên nền */
    top: 520px;                    /* khoảng cách từ trên section */
    right: 540px;                 /* cách phải section */
    font-size: 50px;              /* cỡ chữ vừa phải */
    color: #029221;               /* màu chữ tối */
    font-weight: bold;            /* trên nền, dưới camera nếu cần */
    text-align: center;
}

</style>
</head>
<body>
  <main>
  <section class="cauhoi">
  <section class="img">
      <img src="https://i.postimg.cc/VLSXkytq/Nen.png" alt="anh_nen">
  </section>
  <div id="question"></div>
  <div id="reader"></div>
  <div id="answerResult">Quét QR đáp án A/B/C/D hoặc upload file QR</div>
  <button id="nextBtn" onclick="nextQuestion()">Câu tiếp theo</button>

  <div id="uploadDiv">
      <input type="file" id="qrUpload" accept="image/*">
  </div>
  <!-- Form nhập tên người chơi -->
<div id="playerForm" style="text-align:center; margin-top:20px;">
    <label>Hãy nhập họ và tên của bạn: </label>
    <input type="text" id="playerNameInput" placeholder="Nguyễn Văn A">
    <button id="startBtn">Bắt đầu Quiz</button>
</div>

<!-- Thống kê cho người chơi hiện tại -->
<div id="stats" ></div>

<!-- Khu vực danh sách tổng hợp (ẩn người chơi) -->
<div id="playerListSection" style="display:none; margin-top:20px;">
    <h3>Danh sách người chơi:</h3>
    <ul id="players"></ul>
    <button id="exportBtn">Xuất danh sách</button>
</div>
<script>
// Quiz
const quiz = [
    { q: "Câu 1. Trong hàm đệ quy tính tổng \n S(n) = 1 + 2 + ... + n \n điều kiện dừng phù hợp nhất là gì?\nA. S(n) = n\nB. S(1) = 1\nC. S(0) = 0\nD. S(n) = S(n) + 1", correct: "C" },
    { q: "Câu 2. Một mô hình có số ô được xác định như sau: Hình 1 có 1 ô, hình 2 có 3 ô, hình 3 có 6 ô,… Nếu mỗi hình thứ n được tạo bằng cách thêm n ô vào hình thứ n–1, công thức đệ quy của số ô T(n) là:\nA. T(n) = n\nB. T(n) = T(n – 1) × n\nC. T(n) = T(n – 1) + n\nD. T(n) = T(n) + 1", correct: "C" },
    { q: "Câu 3. Công thức đệ quy đúng cho giai thừa n! là công thức nào?\nA. n! = (n – 1) × (n – 2)!\nB. n! = n + (n – 1)!\nC. n! = n × n\nD. n! = n × (n – 1)!", correct: "D" },
    { q: "Câu 4. Ốc sên leo cầu thang mỗi ngày nhiều hơn ngày trước 1 bậc (ngày 1: 1 bậc, ngày 2: 2 bậc,…).\nTổng số bậc sau n ngày được xác định bởi:\nA. D(n) = D(n – 1) + n\nB. D(n) = D(n – 1) × n\nC. D(n) = n + 1\nD. D(n) = n – 1", correct: "A" },
    { q: "Câu 5. Cho dãy số:\na₀ = 2\naₙ = aₙ₋₁ + 3\nHỏi a₂ bằng bao nhiêu?\nA. 9\nB. 8\nC. 11\nD. 34", correct: "B" }
];

// Biến trạng thái
let currentIndex = 0;
let correctCount = 0;
let playerName = "";
let allPlayers = [];

// Hiển thị câu hỏi
function showQuestion(index){
    const qDiv = document.getElementById("question");
    const ansDiv = document.getElementById("answerResult");
    const btn = document.getElementById("nextBtn");
    qDiv.textContent = quiz[index].q;
    ansDiv.textContent = "Quét QR đáp án A/B/C/D hoặc upload file QR";
    ansDiv.style.color = "rgb(163, 121, 4)";
    btn.style.display = "none";
}

// Xử lý kết quả
function processAnswer(ans){
    const ansDiv = document.getElementById("answerResult");
    const btn = document.getElementById("nextBtn");
    const question = quiz[currentIndex];

    if(["A","B","C","D"].includes(ans)){
        if(ans === question.correct){
            ansDiv.textContent = "Chính xác! Chúc mừng bạn!";
            ansDiv.style.color = "green";
            correctCount++;
        } 
        else {
            ansDiv.textContent = "Chưa chính xác! (Bạn chọn "+ans+", đáp án đúng: "+question.correct+")";
            ansDiv.style.color = "red";
        }
        btn.style.display = "inline-block";
    } else {
        ansDiv.textContent = "QR không hợp lệ";
        ansDiv.style.color = "red";
    }
    updateStats();
}

// Quét QR từ camera
function onScanSuccess(decodedText) {
    const ans = decodedText.trim().toUpperCase();
    processAnswer(ans);
}

// Next question
function nextQuestion(){
    currentIndex++;
    if(currentIndex >= quiz.length){
        document.getElementById("question").textContent = "Bạn đã hoàn thành bài quiz!";
        document.getElementById("answerResult").textContent = "";
        document.getElementById("nextBtn").style.display = "none";
        scanner.stop();

        // Lưu người chơi
        allPlayers.push({ name: playerName, score: correctCount });
        updatePlayerList();
    } else {
        showQuestion(currentIndex);
    }
}

// Thống kê
function updateStats() {
    document.getElementById("stats").textContent = `${playerName}: ${correctCount} / ${quiz.length}`;
}

// Danh sách tổng hợp người chơi
function updatePlayerList() {
    const playerListSection = document.getElementById("playerListSection");
    const ul = document.getElementById("players");
    ul.innerHTML = "";
    allPlayers.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.name} - ${p.score} / ${quiz.length}`;
        ul.appendChild(li);
    });
    playerListSection.style.display = "block";
}

// Bắt đầu quiz sau khi nhập tên
document.getElementById("startBtn").addEventListener("click", () => {
    const nameInput = document.getElementById("playerNameInput").value.trim();
    if(nameInput === "") {
        alert("Vui lòng nhập tên trước khi bắt đầu!");
        return;
    }
    playerName = nameInput;
    document.getElementById("playerForm").style.display = "none";
    showQuestion(currentIndex);
    updateStats();
});

// Xuất danh sách
document.getElementById("exportBtn").addEventListener("click", () => {
    const content = allPlayers.map(p => `${p.name} - ${p.score} / ${quiz.length}`).join("\n");
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "danh_sach_nguoi_choi.txt";
    link.click();
});

// Khởi chạy camera
showQuestion(currentIndex);
let scanner = new Html5Qrcode("reader");
scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
);

// Upload QR
document.getElementById("qrUpload").addEventListener("change", function(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(){
        const img = new Image();
        img.src = reader.result;
        img.onload = function(){
            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if(code){
                processAnswer(code.data.trim().toUpperCase());
            } else {
                alert("Không nhận dạng được QR code. Chọn file khác thử lại.");
            }
        }
    }
    reader.readAsDataURL(file);
});
</script>

</section>
</main>
</body>
</html>
